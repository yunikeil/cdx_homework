name: Supply Chain Security (CycloneDX + Dependency-Check + Dependency-Track)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    name: build - generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (for SBOM tooling)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Generate CycloneDX SBOM (prod)
        run: |
          cyclonedx-py requirements -i requirements.txt -o sbom-prod.json

      - name: Generate CycloneDX SBOM (dev)
        run: |
          cyclonedx-py requirements -i requirements-dev.txt -o sbom-dev.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-prod.json
            sbom-dev.json
          retention-days: 7

  security:
    name: security - dependency-check + dependency-track
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: .

      # Кэшируем dc-data, чтобы не качать NVD заново каждый PR
      - name: Cache Dependency-Check data
        uses: actions/cache@v4
        with:
          path: dc-data
          key: dc-data-${{ runner.os }}-v1
          restore-keys: |
            dc-data-${{ runner.os }}-

      - name: Update Dependency-Check DB (updateonly)
        run: |
          mkdir -p dc-data
          docker run --rm \
            -v "${{ github.workspace }}/dc-data:/usr/share/dependency-check/data" \
            owasp/dependency-check:latest \
            --nvdApiKey "${{ secrets.NVD_API_KEY }}" \
            --updateonly

      - name: Run Dependency-Check scan (no update)
        run: |
          mkdir -p reports/dc
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            -v "${{ github.workspace }}/reports/dc:/report" \
            -v "${{ github.workspace }}/dc-data:/usr/share/dependency-check/data" \
            owasp/dependency-check:latest \
            --scan /src/requirements.txt \
            --scan /src/requirements-dev.txt \
            --format "HTML" --format "JSON" \
            --out /report \
            --project "fastapi-sbom-demo-pr-${{ github.event.pull_request.number }}" \
            --log /report/dc.log \
            --prettyPrint \
            --noupdate

      - name: Upload Dependency-Check reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: reports/dc
          retention-days: 7

      - name: Upload SBOM to Dependency-Track (prod)
        if: ${{ secrets.DT_URL != '' && secrets.DT_API_KEY != '' && secrets.DT_PROJECT_UUID != '' }}
        run: |
          curl -sS -X POST "${{ secrets.DT_URL }}/api/v1/bom" \
            -H "X-Api-Key: ${{ secrets.DT_API_KEY }}" \
            -F "project=${{ secrets.DT_PROJECT_UUID }}" \
            -F "bom=@sbom-prod.json"

      - name: Upload SBOM to Dependency-Track (dev)
        if: ${{ secrets.DT_URL != '' && secrets.DT_API_KEY != '' && secrets.DT_PROJECT_UUID != '' }}
        run: |
          curl -sS -X POST "${{ secrets.DT_URL }}/api/v1/bom" \
            -H "X-Api-Key: ${{ secrets.DT_API_KEY }}" \
            -F "project=${{ secrets.DT_PROJECT_UUID }}" \
            -F "bom=@sbom-dev.json"
